<!-- nerveBall Web Version copymiddle 2024 Jaakko Prättälä -->
<!DOCTYPE html>
<html>
    <head>
        <title>nerveBall</title>
        <link rel="stylesheet" type="text/css" href="nerveballweb.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
        <script src="nerveballweb.js"></script>
    </head>
    <body> 
        <script type="text/javascript">
            let cnv, cnvElt;
            var bgcolor = 0;

            function setup() {
                cnv = createCanvas(800, 800);
                cnvElt = cnv.elt;
                cnvElt.id = "nerveball";
                createCanvas(800, 800);
                background(0);
                fill(255);
                frameRate(60);
            }

            function draw() {
                if (lane==2){
                    timeStopped = true;
                    //handle game over
                    background(0);
                    //draw text
                    fill(255);
                    textSize(32);
                    text("Game over!", 10, 30);
                    text("Points: " + player_points, 10, 60);
                    text("Time bonus: " + player_time, 10, 90);
                    text("Total points: " + (player_points + player_time), 10, 120);

                    //wait for space key
                    if (keyIsDown(32)) {
                        document.location.reload();
                    }

                } else if (lane==1){
                    //handle time out
                    background(0);
                    //delete balls
                    ball_amount = 0;
                    //draw text
                    fill(255);
                    textSize(32);
                    text("Time out!", 10, 30);
                    text("Points: " + player_points, 10, 60);
                    //wait for space key
                    if (keyIsDown(32)) {
                        document.location.reload();
                    }
                } else if (lane == 0){

                    //clear canvas
                    background(0);

                    //update ball neural activations
                    countActivations();

                    //backpropagate
                    for (var i = 0; i < ball_amount; i++) {
                        backPropagate(i);
                    }

                    //move balls
                    for (var i = 0; i < ball_amount; i++) {
                        moveBall(i);
                    }
                    
                    //draw balls
                    for (var i = 0; i < ball_amount; i++) {
                        fill(255-ball_size[i]*2, 255-ball_size[i]*3, Math.abs(Math.round(ball_na[i]/32*255)));
                        ellipse(ball_x[i], ball_y[i], ball_size[i], ball_size[i]);
                    }
                    
                    /* DEBUG
                    //draw neural activations
                    fill(0, 255, 0)
                    for (var i = 0; i < ball_amount; i++) {
                        text(ball_na[i], ball_x[i], ball_y[i]);
                    }*/
                    //handle mouse input
                    if (mouseIsPressed) {
                        if (ball_amount == 0 && lane == 0){
                            lane = 2;
                        } else {
                            for (var i = 0; i < ball_amount; i++) {
                                if (dist(mouseX, mouseY, ball_x[i], ball_y[i]) < ball_size[i] / 2 + 7) {
                                    splitBall(i);
                                }
                            }
                    }
                }
            }
        }

        </script>
        <div id="time" class="time">Time</div>
        <div id="points" class="points">Points</div>
    </body>
</html>
