<!--
nerveBall - a simple game made with p5.js
by Jaakko Prättälä 2024.
Licensed under GPL v3.
see LICENSE file for details.

-->
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>nerveBall</title>
        <link rel="stylesheet" type="text/css" href="nerveballweb.css">
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
        <script src="nerveballweb.js"></script>
    </head>
    
    <body> 

        <script type="text/javascript">

            
            //audio stuff

            function preload() {
                nbaudio_ballsplit01 = loadSound('ballsplit01.mp3');
                nbaudio_scoregain01 = loadSound('scoregain01.mp3');
                nbaudio_timegain01 = loadSound('timegain01.mp3');
                nbaudio_bgmusic01 = loadSound('bgmusic01.mp3');
                nbaudio_TheBigBall = loadSound('TheBigBall.mp3');
                //no loop
                nbaudio_ballsplit01.setLoop(false);
                nbaudio_scoregain01.setLoop(false);
                nbaudio_timegain01.setLoop(false);
                nbaudio_bgmusic01.setLoop(true);
                nbaudio_TheBigBall.setLoop(false);
            }




            //game stuff
            let cnv, cnvElt;
            var scoreText;
            var lastScore = 0;
            var hitMargin = 7; //mouse hit margin
            var scoreTextDisappearanceCountDown = 93;

            var body = document.getElementsByTagName("body")[0];
            body.style.backgroundColor = "rgb(0, 0, 0)";
            //timed loop for changing background color of the body
            setInterval(function() {
                //modulate background color blue channel with a sine wave
                body.style.backgroundColor = "rgb(0, 0, " + Math.round(64 * Math.abs(Math.sin(Date.now() / 1000))) + ")";
            }, 10);

            function setup() {                
                cnv = createCanvas(800, 800);
                cnvElt = cnv.elt;
                cnvElt.id = "nerveball";
                cnvElt.style.display = "block";
                cnvElt.style.margin = "auto";
                background(0);
                fill(255);
                frameRate(60);
                //play bg music
                nbaudio_bgmusic01.setVolume(0.3);
                nbaudio_bgmusic01.play();
            }

            //variables for score notification
            var hit = false;
            var hitX = 0;
            var hitY = 0;
            var r;
            var g;
            var b;
            function draw() {
                if (theBigBall){nbaudio_TheBigBall.play();theBigBall = false;}
                if (hit){
                    fill(r, g, b);
                    textSize(32);
                    text(lastScore, hitX, hitY);
                }

                if (lane == 3){
                    gameOn = false;
                    timeStopped = true;
                    
                    //change quit button text to 'reload'
                    var sirrobin = document.getElementById("sirrobin");
                    sirrobin.innerHTML = "Reload";
                    //set quit button onclick to reload
                    sirrobin.onclick = function() {
                        document.location.reload();
                    };

                    background(0);
                    fill(10, 255, 10);
                    textSize(32);
                    //font courier new
                    textFont('Courier New');
                    text("Sir Robin ran away.", 130, 30);
                    var timeBonus = Math.round(player_time);
                    var score = player_points + timeBonus;
                    text("Points: " + player_points, 200, 60);
                    text("Time bonus: " + timeBonus, 200, 90);
                    text("Score: " + score, 200, 120);

                    if (player_points >= 0){player_points-=10000;}
                    if (player_time >= 0){player_time-=10000;}

                    //wait for space key
                    if (keyIsDown(32)) {
                        document.location.reload();
                    }
                } else
                if (lane==2){
                    timeStopped = true;
                    gameOn = false;
                    //change quit button text to 'reload'
                    var sirrobin = document.getElementById("sirrobin");
                    sirrobin.innerHTML = "Reload";
                    //set quit button onclick to reload
                    sirrobin.onclick = function() {
                        document.location.reload();
                    };
                    //handle game over
                    background(0);
                    //delete balls
                    ball_amount = 0;
                    //draw text
                    fill(10, 255, 10);
                    textSize(32);
                    //font courier new
                    textFont('Courier New');
                    text("Game Over, Balls Destroyed.", 100, 30);
                    //
                    var timeBonus = Math.round(player_time);
                    var score = player_points + timeBonus;
                    text("Points: " + player_points, 200, 60);
                    text("Time bonus: " + timeBonus, 200, 90);
                    text("Score: " + score, 200, 120);
                    //wait for space key
                    if (keyIsDown(32)) {
                        document.location.reload();
                    }
                } else if (lane==1){
                    timeStopped = true;
                    gameOn = false;
                    //change quit button text to 'reload'
                    var sirrobin = document.getElementById("sirrobin");
                    sirrobin.innerHTML = "Reload";
                    //set quit button onclick to reload
                    sirrobin.onclick = function() {
                        document.location.reload();
                    };
                    //handle game over
                    background(0);
                    //delete balls
                    ball_amount = 0;
                    //draw text
                    fill(10, 255, 10);
                    textSize(32);
                    //font courier new
                    textFont('Courier New');
                    text("Game Over, Out of Time.", 100, 30);
                    //
                    var timeBonus = Math.round(player_time);
                    var score = player_points + timeBonus;
                    text("Points: " + player_points, 200, 60);
                    text("Time bonus: " + timeBonus, 200, 90);
                    text("Score: " + score, 200, 120);

                    //wait for space key
                    if (keyIsDown(32)) {
                        document.location.reload();
                    }
                } else if (lane == 0){
                    //DEBUG and TESTING
                    //wait for number 1 or 2 key for lane selection
                    if (keyIsDown(49)) {
                        lane = 1;
                    } else if (keyIsDown(50)) {
                        lane = 2;
                    }
                    gameOn = true;
                    //clear canvas
                    background(0);

                    //update ball neural activations
                    countActivations();

                    //backpropagate
                    for (var i = 0; i < ball_amount; i++) {
                        backPropagate(i);
                    }

                    //move balls
                    for (var i = 0; i < ball_amount; i++) {
                        moveBall(i);
                    }
                    
                    //draw balls
                    for (var i = 0; i < ball_amount; i++) {
                        var ballR = 255 - ball_size[i]*5;
                        var ballG = 255 - ball_size[i]*8;
                        var ballB = Math.abs(Math.round(ball_na[i]/32*255));

                        if (ballR < 0) {ballR = 255;}
                        if (ballG < 0) {ballG = 255;}
                        if (ballB < 0) {ballB = 255;}
                        fill(ballR, ballG, ballB);
                        ellipse(ball_x[i], ball_y[i], ball_size[i], ball_size[i]);
                        if (hit){
                            fill(r, g, b);
                            textSize(32);
                            text(lastScore, hitX, hitY)
                        }
                    }
                    
                    /* DEBUG
                    //draw neural activations
                    fill(0, 255, 0)
                    for (var i = 0; i < ball_amount; i++) {
                        text(ball_na[i], ball_x[i], ball_y[i]);
                    }*/
                    //handle mouse input
                    if (mouseIsPressed) {

                        if (ball_amount == 0 && lane == 0){
                            lane = 2;
                        } else {
                            for (var i = 0; i < ball_amount; i++) {
                                var distance = dist(mouseX, mouseY, ball_x[i], ball_y[i]);
                                if (ball_size[i] == 11 && distance < ball_size[i] / 2 + hitMargin) {
                                    nbaudio_playSample_timegain01();
                                }
                                if (distance < ball_size[i] / 2 + hitMargin) {
                                    hit = true;
                                    splitBall(i);
                                    r = 255;
                                    g = 255;
                                    b = 255;
                                    hitX = mouseX;
                                    hitY = mouseY;
                                    lastScore = Math.round(player_lastSplitPoints);
                                    scoreTextDisappearanceCountDown = 13;
 
                                    setInterval(function tdcd() {
                                        scoreTextDisappearanceCountDown--;
                                        if (scoreTextDisappearanceCountDown <= 0){
                                            clearInterval(tdcd);
                                            hit = false;
                                            return;
                                        }
                                        r = r - 135/scoreTextDisappearanceCountDown * 2;
                                        g = g - 122/scoreTextDisappearanceCountDown * 4
                                        b = b - 120/scoreTextDisappearanceCountDown * 6;
                                        if (r < 0) {r = 255;}
                                        if (g < 0) {g = 255;}
                                        if (b < 0) {b = 255;}
                                    }, 100);
                                    // update score div
                                    var points = document.getElementById("points");
                                    points.innerHTML = "Points: " + Math.round(player_points) + " Last split: " + Math.round(player_lastSplitPoints);

                                    // play sound
                                    nbaudio_playSample_ballsplit01();
                                    
                                    if (player_lastSplitPoints > 0){
                                        var scoreSoundPlayTimes = player_lastSplitPoints / 10000;
                                        
                                        var scoreCounter = setInterval(function() {
                                            if (scoreSoundPlayTimes > 0){
                                                nbaudio_playSample_scoregain01();
                                                scoreSoundPlayTimes--;
                                            } else {
                                                clearInterval(scoreCounter);
                                            }
                                        }, 100); // Delay in milliseconds
                                    }
                                }
                            }
                        }
                    }
                }
            }


        </script>
        <div id="time" class="time">Time</div>
        <div id="points" class="points">Points</div>
        <div id="ballAmount" class="ballAmount">Balls</div>
        <button id="fullScreen" class="fullScreen" onclick="toggleFullScreen()"> Toggle Fullscreen mode</button>
        <button id="sirrobin" class="sirrobin" onclick="sirRobinOut()"> Quit </button>
    </body>
</html>
